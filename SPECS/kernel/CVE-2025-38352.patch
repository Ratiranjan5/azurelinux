From f33039f22ea2f0f9429d21f358e6387780ce1562 Mon Sep 17 00:00:00 2001
From: Madhur Aggarwal <madaggarwal@microsoft.com>
Date: Fri, 25 Jul 2025 09:53:54 +0000
Subject: [PATCH] Patch CVE-2025-38352

Upstream Patch Reference: https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2c72fe18cc5f9f1750f5bc148cf1c94c29e106ff
---
 kernel/time/posix-cpu-timers.c | 9 +++++++++
 1 file changed, 9 insertions(+)

diff --git a/kernel/time/posix-cpu-timers.c b/kernel/time/posix-cpu-timers.c
index e9c6f9d0e..9af1f2a72 100644
--- a/kernel/time/posix-cpu-timers.c
+++ b/kernel/time/posix-cpu-timers.c
@@ -1437,6 +1437,15 @@ void run_posix_cpu_timers(void)
 
 	lockdep_assert_irqs_disabled();
 
+	/*
+	 * Ensure that release_task(tsk) can't happen while
+	 * handle_posix_cpu_timers() is running. Otherwise, a concurrent
+	 * posix_cpu_timer_del() may fail to lock_task_sighand(tsk) and
+	 * miss timer->it.cpu.firing != 0.
+	 */
+	if (tsk->exit_state)
+		return;
+
 	/*
 	 * If the actual expiry is deferred to task work context and the
 	 * work is already scheduled there is no point to do anything here.
-- 
2.45.4

