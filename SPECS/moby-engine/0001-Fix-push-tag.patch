From 2a7d05ee7f46f766fc456b9636f69fbc0b270bd9 Mon Sep 17 00:00:00 2001
From: Kavya Sree Kaitepalli <kkaitepalli@microsoft.com>
Date: Tue, 9 Sep 2025 05:52:45 +0000
Subject: [PATCH] Fix push tag

---
 daemon/containerd/image_push.go | 11 ++++++++++-
 1 file changed, 10 insertions(+), 1 deletion(-)

diff --git a/daemon/containerd/image_push.go b/daemon/containerd/image_push.go
index 06f47bf..99852a5 100644
--- a/daemon/containerd/image_push.go
+++ b/daemon/containerd/image_push.go
@@ -131,7 +131,16 @@ func (i *ImageService) pushRef(ctx context.Context, targetRef reference.Named, m
 	wrapped := wrapWithFakeMountableBlobs(store, mountableBlobs)
 	store = wrapped
 
-	pusher, err := resolver.Pusher(ctx, targetRef.String())
+	// Annotate ref with digest to push only push tag for single digest
+	ref := targetRef
+	if _, digested := ref.(reference.Digested); !digested {
+		ref, err = reference.WithDigest(ref, target.Digest)
+		if err != nil {
+			return err
+		}
+	}
+
+	pusher, err := resolver.Pusher(ctx, ref.String())
 	if err != nil {
 		return err
 	}
-- 
2.45.4

